{
    "id": "org.freedesktop.LinuxAudio.Lv2Plugin.Carla",
    "runtime": "org.freedesktop.LinuxAudio.BaseApp//20.04",
    "sdk": "org.kde.Sdk//5.14",
    "build-extension": true,
    "appstream-compose": false,
    "build-options": {
        "prepend-path": "/app/extensions/Carla/bin",
        "prepend-pkg-config-path": "/app/extensions/Carla/lib/pkgconfig",
        "prepend-ld-library-path": "/app/extensions/Carla/lib",
        "prefix": "/app/extensions/Carla"
    },
    "modules": [
        {
            "name" : "pyqt5",
            "config-opts" : [
                "--disable-static",
                "--enable-x11"
            ],
            "sources" : [
                {
                    "type" : "archive",
                    "url" : "https://sourceforge.net/projects/pyqt/files/PyQt5/PyQt-5.11.3/PyQt5_gpl-5.11.3.zip",
                    "sha256" : "7cacf0712d76a702e0e2102a65f411fd72e7f64a851a47a72c03fbafbe447aae"
                },
                {
                    "type": "script",
                    "commands": [
                        "python3 configure.py --assume-shared --confirm-license --no-designer-plugin --no-qml-plugin --sysroot=/app/extensions/Carla --qsci-api --qsci-api-destdir=/app/extensions/Carla/qsci --sipdir=/app/extensions/Carla/share/sip --sip=/app/extensions/Carla/bin/sip --sip-incdir=/app/extensions/Carla/include QMAKE_CFLAGS_RELEASE='-I/usr/include/python3.7m/' QMAKE_CXXFLAGS_RELEASE='-I/usr/include/python3.7m/'"
                    ],
                    "dest-filename": "configure"
                }
            ],
            "modules" : [
                {
                    "name" : "sip",
                    "sources" : [
                        {
                            "type" : "archive",
                            "url" : "https://sourceforge.net/projects/pyqt/files/sip/sip-4.19.12/sip-4.19.12.tar.gz",
                            "sha256" : "24617fc31b983df075500ecac0e99d2fb48bf63ba82d4a17518659e571923822"
                        },
                        {
                            "type": "script",
                            "commands": [
                                "python3 configure.py --sip-module PyQt5.sip -b ${FLATPAK_DEST}/bin -d ${FLATPAK_DEST}/lib/python3.7/site-packages -e ${FLATPAK_DEST}/include -v ${FLATPAK_DEST}/share/sip --stubsdir=${FLATPAK_DEST}/lib/python3.7/site-packages"
                            ],
                            "dest-filename": "configure"
                        }
                    ],
                    "cleanup": [
                        "/bin",
                        "/include"
                    ]
                }
            ]
        },
        {
            "name": "carla",
            "buildsystem": "simple",
            "build-options": {
                "env": {
                    "PREFIX": "/app/extensions/Carla",
                    "PYTHONPATH": "/app/extensions/Carla/lib/python3.7/site-packages"
                }
            },
            "build-commands": [
                "make PREFIX=/app/extensions/Carla -j $FLATPAK_BUILDER_N_JOBS",
                "make PREFIX=/app/extensions/Carla install"
            ],
            "post-install": [
                "for s in /app/extensions/Carla/bin/carla*; do sed -i '/^INSTALL_PREFIX=.*/a export PYTHONPATH=\"$INSTALL_PREFIX/lib/python3.7/site-packages\"' $s ; done",
                "for s in /app/extensions/Carla/lib/lv2/carla.lv2/resources/carla-plugin*; do sed -i '/^from PyQt5.QtGui/i import sys\\nsys.path.append(\"/app/extensions/Carla/lib/python3.7/site-packages\")\\n' $s ; done",
                "install -Dm644 --target-directory=${FLATPAK_DEST}/share/metainfo org.freedesktop.LinuxAudio.Lv2Plugin.Carla.metainfo.xml",
                "appstream-compose --basename=org.freedesktop.LinuxAudio.Lv2Plugin.Carla --prefix=${FLATPAK_DEST} --origin=flatpak org.freedesktop.LinuxAudio.Lv2Plugin.Carla",
                "install -d /app/extensions/Carla/lv2",
                "ln -sf ../lib/lv2/carla.lv2 /app/extensions/Carla/lv2/"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/falkTX/Carla/archive/v2.1.tar.gz",
                    "sha256": "a82ce08f3a82db9d878c8cb7e7e2f3b80834bf21801c6ec4ed95c0cfee25b963"
                },
                {
                    "type": "file",
                    "path": "org.freedesktop.LinuxAudio.Lv2Plugin.Carla.metainfo.xml"
                }
            ]
        }
    ]
}
